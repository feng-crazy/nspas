# 神经科学修行助手详细设计文档

## 1. 系统架构详细设计

### 1.1 后端服务架构
后端采用Go + Python混合架构：

#### 1.1.1 Go服务层
- **技术栈**：Gin框架
- **功能职责**：
  - 高并发请求处理
  - 用户信息管理
  - 会话管理
  - 路由转发给Python AI层

#### 1.1.2 Python AI层
- **技术栈**：LangChain、LlamaIndex、LangServe
- **功能职责**：
  - 构建对话问答Agent
  - 构建修行方案计划Agent
  - 集成国产大模型
  - 实现长短期记忆功能
  - 支持联网搜索MCP

### 1.2 数据存储设计
- **数据库**：MongoDB
- **存储内容**：
  - 用户基本信息
  - 对话历史记录
  - 修行方案记录
  - 修行打卡记录
  - 成长感悟记录

## 2. 核心模块详细设计

### 2.1 智能对话引擎

#### 2.1.1 用户多轮情感分析
- **功能描述**：实时识别文本中的情绪维度，结合上下文和对话历史追踪情绪演变轨迹
- **技术实现**：
  - 使用情感分析模型（如BERT-based情感分类器）
  - 维护会话上下文状态
  - 跟踪情绪变化趋势

#### 2.1.2 神经科学映射
- **功能描述**：将用户思维描述自动关联到神经通路
- **技术实现**：
  - 构建神经科学概念词典
  - 实现自然语言到神经通路的映射算法
  - 支持修行语录的脑科学释义

#### 2.1.3 动态知识调用
- **功能描述**：根据用户输入动态检索相关神经科学知识
- **技术实现**：
  - 基于LlamaIndex构建神经科学知识图谱
  - 实现多级检索策略（关键词+语义相似度+神经通路关联）
  - 集成联网搜索MCP

### 2.2 核心功能模块

#### 2.2.1 思维症状-机制解释器
- **功能描述**：将用户描述的症状转换为神经科学解释
- **输入**：用户描述的症状文本
- **输出**：对应的神经机制解释和建议
- **示例**：
  ```
  用户输入："最近总失眠焦虑"
  输出："这可能与杏仁核过度活跃抑制松果体褪黑素分泌有关，建议尝试478呼吸法调节副交感神经"
  ```

#### 2.2.2 修行语录的神经科学解释器
- **功能描述**：将哲学和修行语录转换为神经科学解释
- **输入**：修行语录文本
- **输出**：对应的神经科学解释
- **示例**：
  ```
  用户输入："知行合一，为什么我'知而不行'"
  输出：包含神经断层分析和关键洞见的详细解释
  ```

#### 2.2.3 交互式知识问答
- **功能描述**：支持用户追问机制的知识问答系统
- **功能特点**：
  - 支持多轮对话
  - 上下文关联理解
  - 知识库检索与大模型结合

#### 2.2.4 修行方案生成器
- **功能描述**：根据用户状态和需求生成个性化修行方案
- **输入**：用户情绪状态、神经机制分析结果
- **输出**：结构化训练计划
- **示例输出**：
  ```markdown
  [神经可塑性训练]
  ▶ 每日任务：
    - 早晨10分钟正念呼吸（增强前额叶-杏仁核连接）
    - 睡前感恩日记（提升血清素水平）
  ▶ 科学依据：Davidson, 2003 fMRI研究证实...
  ```

### 2.3 修行记录功能

#### 2.3.1 记录表格生成
- **功能描述**：根据生成的修行方案智能生成记录表格
- **表格内容**：
  - 日期
  - 任务完成情况
  - 用户感悟

#### 2.3.2 记录管理
- **功能描述**：用户可以查看、编辑、导出修行记录
- **支持功能**：
  - 按日期筛选
  - 按任务类型筛选
  - 数据统计和可视化

## 3. 关键组件设计

### 3.1 智能问答组件
- **功能描述**：调用大模型结合知识库回答用户问题
- **Prompt模板**：
  ```
  你是一名神经科学与修行实践者，如何从神经脑科学角度，理解{用户输入}，下面信息可以提供一些语境信息，{知识库检索内容}，{搜索引擎提供的案例}，{用户对话历史}
  ```

### 3.2 修行方案计划生成器
- **功能描述**：根据用户状态生成修行方案
- **Prompt模板**：
  ```
  基于{用户情绪状态}和{神经机制}，生成包含{科学依据}的{天数}天训练计划
  ```

### 3.3 问答与修行记录组件
- **功能描述**：记录用户交互历史和修行进展
- **记录内容**：
  - 聊天历史
  - 修行打卡记录
  - 成长感悟记录

## 4. 接口设计

### 4.1 用户服务接口
- `POST /api/user/login` - 用户登录
- `GET /api/user/profile` - 获取用户信息
- `PUT /api/user/profile` - 更新用户信息

### 4.2 对话服务接口
- `POST /api/chat/message` - 发送消息
- `GET /api/chat/history` - 获取对话历史
- `DELETE /api/chat/history` - 清除对话历史

### 4.3 修行方案接口
- `POST /api/plan/generate` - 生成修行方案
- `GET /api/plan/list` - 获取方案列表
- `GET /api/plan/{id}` - 获取方案详情

### 4.4 记录服务接口
- `POST /api/record/checkin` - 打卡记录
- `GET /api/record/list` - 获取记录列表
- `PUT /api/record/{id}` - 更新记录

## 5. 数据模型设计

### 5.1 用户模型 (User)
```json
{
  "id": "string",
  "wechat_id": "string",
  "nickname": "string",
  "avatar": "string",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

### 5.2 对话记录模型 (ChatMessage)
```json
{
  "id": "string",
  "user_id": "string",
  "message": "string",
  "role": "string", // user or assistant
  "timestamp": "datetime",
  "emotion_analysis": {
    "emotion": "string",
    "confidence": "number"
  }
}
```

### 5.3 修行方案模型 (PracticePlan)
```json
{
  "id": "string",
  "user_id": "string",
  "title": "string",
  "days": "number",
  "tasks": [
    {
      "day": "number",
      "title": "string",
      "description": "string",
      "scientific_basis": "string"
    }
  ],
  "created_at": "datetime"
}
```

### 5.4 修行记录模型 (PracticeRecord)
```json
{
  "id": "string",
  "user_id": "string",
  "plan_id": "string",
  "date": "date",
  "completed_tasks": ["string"],
  "reflection": "string",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

## 6. 安全设计

### 6.1 数据安全
- 敏感数据脱敏处理（符合GDPR）
- 对话内容加密存储（AES-256）

### 6.2 访问控制
- 微信认证集成
- 用户会话管理
- API访问权限控制

### 6.3 免责声明
- 明确非诊疗工具声明
- 用户使用风险提示