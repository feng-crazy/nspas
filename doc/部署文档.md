# 部署文档

## 部署架构

神经科学修行助手采用微服务架构，包含以下组件：

1. **前端应用** (web-frontend) - Vue.js单页应用
2. **后端服务** (go-service) - Go语言RESTful API服务
3. **AI服务** (python-ai-service) - Python语言AI推理服务
4. **数据库** (MongoDB) - NoSQL文档数据库

## 环境变量配置

在生产环境中，需要正确配置以下环境变量：

### Go服务环境变量

```bash
# MongoDB配置
MONGODB_URI=mongodb://username:password@host:port/database
MONGODB_NAME=neuro_guide

# Python AI服务地址
PYTHON_AI_SERVICE_URL=http://python-ai-service:8000

# 服务端口
PORT=8080

# 微信登录配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret
```

### Web前端环境变量

```env
# API基础URL
VITE_API_BASE_URL=https://your-api-domain.com/api

# 微信AppID
VITE_WECHAT_APP_ID=your_wechat_app_id
```

## Docker部署

项目根目录下的 `docker-compose.yml` 文件定义了完整的部署配置：

```yaml
version: '3.8'
services:
  # MongoDB数据库
  mongodb:
    image: mongo:6.0
    container_name: neuro-guide-mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"

  # Go后端服务
  go-service:
    build: ./go-service
    container_name: neuro-guide-go-service
    restart: always
    ports:
      - "8080:8080"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
      - MONGODB_NAME=neuro_guide
      - PYTHON_AI_SERVICE_URL=http://python-ai-service:8000
      - PORT=8080
      - WECHAT_APP_ID=${WECHAT_APP_ID}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET}
    depends_on:
      - mongodb
      - python-ai-service

  # Python AI服务
  python-ai-service:
    build: ./python-ai-service
    container_name: neuro-guide-python-ai-service
    restart: always
    ports:
      - "8000:8000"
    environment:
      - PORT=8000

  # Nginx反向代理
  nginx:
    build: ./nginx
    container_name: neuro-guide-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - go-service
      - python-ai-service
    volumes:
      - ./web-frontend/dist:/usr/share/nginx/html

volumes:
  mongodb_data:
```

## 部署步骤

### 1. 准备工作

1. 安装Docker和Docker Compose
2. 克隆项目代码到服务器
3. 配置环境变量

### 2. 构建前端应用

```bash
cd web-frontend
npm install
npm run build
```

### 3. 启动服务

```bash
# 在项目根目录执行
docker-compose up -d
```

### 4. 查看服务状态

```bash
docker-compose ps
```

## 微信登录配置

### 1. 公众平台配置

1. 登录微信公众平台
2. 进入"开发" -> "接口权限" -> "网页服务" -> "网页授权"
3. 设置"授权回调页面域名"为你的网站域名

### 2. 获取AppID和AppSecret

1. 登录微信公众平台
2. 进入"开发" -> "基本配置"
3. 记录下"开发者ID(AppID)"和"开发者密码(AppSecret)"

### 3. 环境变量设置

将获取到的AppID和AppSecret设置为环境变量：

```bash
export WECHAT_APP_ID=your_app_id
export WECHAT_APP_SECRET=your_app_secret
```

或者在docker-compose.yml中配置：

```yaml
go-service:
  # ... 其他配置
  environment:
    # ... 其他环境变量
    - WECHAT_APP_ID=your_app_id
    - WECHAT_APP_SECRET=your_app_secret
```

## SSL证书配置

Nginx配置已支持SSL证书，只需将证书文件放置在nginx/ssl目录下：

```
nginx/
├── nginx.conf
└── ssl/
    ├── certificate.crt
    └── private.key
```

然后修改nginx.conf启用SSL配置：

```nginx
server {
    listen 443 ssl;
    server_name your_domain.com;
    
    ssl_certificate /etc/nginx/ssl/certificate.crt;
    ssl_certificate_key /etc/nginx/ssl/private.key;
    
    # ... 其他配置
}
```

## 监控和日志

### 查看服务日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f go-service
```

### 健康检查

各服务均提供健康检查接口：

- Go服务: `GET /api/health`
- Python AI服务: `GET /health`

可以通过curl命令检查：

```bash
curl http://localhost:8080/api/health
curl http://localhost:8000/health
```

## 备份和恢复

### MongoDB备份

使用项目提供的备份脚本：

```bash
./scripts/backup.sh
```

### 手动备份

```bash
docker exec neuro-guide-mongodb mongodump --db neuro_guide --out /dump
docker cp neuro-guide-mongodb:/dump ./backup/
```

## 故障排除

### 服务无法启动

1. 检查Docker和Docker Compose是否正确安装
2. 检查端口是否被占用
3. 检查环境变量是否正确配置

### 微信登录失败

1. 检查微信公众平台配置是否正确
2. 确认回调域名是否与实际部署域名一致
3. 检查AppID和AppSecret是否正确

### 数据库连接失败

1. 检查MongoDB服务是否正常运行
2. 确认数据库连接字符串是否正确
3. 检查网络连接和防火墙设置