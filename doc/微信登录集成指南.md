# 微信登录集成指南

## 概述

本文档详细介绍了如何在神经科学修行助手项目中集成微信登录功能，包括前端SDK集成、后端接口实现以及相关配置说明。

## 微信登录实现原理

微信登录主要通过OAuth2.0协议实现，整体流程如下：

1. 用户点击微信登录按钮
2. 前端引导用户跳转到微信授权页面
3. 用户确认授权后，微信回调前端指定的redirect_uri并附带code参数
4. 前端将code发送至后端
5. 后端使用code向微信服务器换取access_token和用户标识(openid)
6. 后端根据openid在本地系统中查找或创建用户
7. 后端生成本地token并返回给前端
8. 前端使用该token进行后续API请求的身份验证

## 前端微信登录SDK集成

### 1. 安装微信SDK

在网页中使用微信登录，需要引入微信官方的JavaScript SDK：

```html
<script src="https://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js"></script>
```

### 2. 微信扫码登录实现

在Vue组件中实现微信扫码登录功能：

```javascript
// 在LoginView.vue中添加以下方法
const handleWeChatLogin = () => {
  // 获取环境变量中的微信AppID
  const appId = import.meta.env.VITE_WECHAT_APP_ID
  const redirectUri = encodeURIComponent(`${window.location.origin}/wechat-callback`)
  
  // 创建微信登录实例
  const wxLogin = new WxLogin({
    self_redirect: false,
    id: "wechat-login-container",
    appid: appId,
    scope: "snsapi_login",
    redirect_uri: redirectUri,
    state: Math.random().toString(36).substring(2, 15),
    style: "black",
    href: ""
  });
  
  // 显示二维码弹窗
  // 这里可以根据实际需求调整显示方式
  document.getElementById("wechat-login-container").innerHTML = "";
  wxLogin.init();
}
```

### 3. 微信回调页面处理

创建一个专门用于处理微信回调的页面(/public/wechat-callback.html)：

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>微信登录回调</title>
</head>
<body>
    <script>
        // 解析URL参数获取code
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
            // 将code发送到主应用
            window.opener.postMessage({ type: 'wechat_login', code: code }, window.location.origin);
            window.close();
        } else {
            alert('微信登录失败，请重试');
            window.close();
        }
    </script>
</body>
</html>
```

然后在主应用中监听这个消息：

```javascript
// 在LoginView.vue的setup中添加
import { onMounted, onUnmounted } from 'vue';

onMounted(() => {
  const handleMessage = async (event) => {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'wechat_login') {
      try {
        // 调用后端微信登录接口
        const response = await userAPI.wechatLogin(event.data.code);
        
        // 保存用户信息和token
        localStorage.setItem('auth_token', response.data.token);
        localStorage.setItem('user', JSON.stringify(response.data.user));
        
        // 跳转到主页
        router.push('/');
      } catch (error) {
        console.error('微信登录失败:', error);
        loginError.value = '微信登录失败，请重试';
      }
    }
  };
  
  window.addEventListener('message', handleMessage);
  
  // 清理事件监听器
  onUnmounted(() => {
    window.removeEventListener('message', handleMessage);
  });
});
```

### 4. 微信内浏览器登录

如果用户在微信内置浏览器中访问网站，可以使用微信JS-SDK进行登录：

```javascript
// 检测是否在微信中
const isWechat = () => {
  return /micromessenger/i.test(navigator.userAgent);
};

// 微信内浏览器登录
const handleWeChatBrowserLogin = () => {
  // 跳转到微信OAuth页面
  const appId = import.meta.env.VITE_WECHAT_APP_ID;
  const redirectUri = encodeURIComponent(`${window.location.origin}/wechat-callback`);
  const state = Math.random().toString(36).substring(2, 15);
  
  window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appId}&redirect_uri=${redirectUri}&response_type=code&scope=snsapi_userinfo&state=${state}#wechat_redirect`;
};
```

## 配置微信公众平台

### 1. 注册微信公众平台账号

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册一个服务号（不推荐订阅号，因为订阅号无法使用网页授权）
3. 完成企业认证（个人用户无法使用微信登录功能）

### 2. 配置网站授权回调域名

1. 登录微信公众平台
2. 进入"开发" -> "接口权限" -> "网页服务" -> "网页授权"
3. 修改"授权回调页面域名"，填入你的网站域名（例如：yourdomain.com）
   - 注意：不需要加 http:// 或 https://
   - 不需要加路径，只需要域名

### 3. 获取AppID和AppSecret

1. 登录微信公众平台
2. 进入"开发" -> "基本配置"
3. 记录下"开发者ID(AppID)"和"开发者密码(AppSecret)"

## 生产环境配置

### 1. 环境变量设置

在生产环境中，需要正确配置以下环境变量：

```bash
# 微信相关配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# 其他配置
MONGODB_URI=mongodb://username:password@host:port/database
MONGODB_NAME=neuro_guide
PYTHON_AI_SERVICE_URL=http://python-ai-service:8000
PORT=8080
```

### 2. Docker环境配置

如果使用Docker部署，可以在docker-compose.yml中添加环境变量：

```yaml
version: '3.8'
services:
  go-service:
    build: ./go-service
    ports:
      - "8080:8080"
    environment:
      - WECHAT_APP_ID=${WECHAT_APP_ID}
      - WECHAT_APP_SECRET=${WECHAT_APP_SECRET}
      - MONGODB_URI=${MONGODB_URI}
      - PYTHON_AI_SERVICE_URL=http://python-ai-service:8000
    depends_on:
      - mongodb

  # 其他服务...
```

### 3. 前端环境变量配置

在前端项目中，创建`.env.production`文件：

```env
VITE_WECHAT_APP_ID=your_wechat_app_id
VITE_API_BASE_URL=https://your-api-domain.com/api
```

## 安全注意事项

1. **AppSecret保密**：永远不要将AppSecret暴露给前端或客户端代码
2. **HTTPS传输**：确保所有涉及用户认证的信息都通过HTTPS传输
3. **Code一次有效**：微信返回的code只能使用一次，5分钟内有效
4. **Token有效期**：后端生成的token应设置合理的过期时间
5. **防止CSRF攻击**：使用state参数验证请求来源

## 常见问题排查

### 1. redirect_uri参数错误

- 确保回调域名已在微信公众平台配置
- 确保redirect_uri完全匹配（包括协议和路径）

### 2. appid参数错误

- 检查AppID是否正确
- 确认应用已获得微信登录权限

### 3. 授权后无法获取用户信息

- 检查scope参数是否正确设置为snsapi_userinfo
- 确认应用已完成微信认证

## 测试建议

1. 在开发环境中使用开发者登录功能进行测试
2. 在测试公众号中进行微信登录功能测试
3. 确保在各种网络环境下都能正常工作
4. 测试登录超时和异常处理逻辑